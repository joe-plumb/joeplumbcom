# Serverless functions with Azure and Python
_Date posted: 2020-08-25_

_Posted by: Joe_

I've been working with Azure Functions since late last year - my first real opportunity to work with them came about during the [App Modernization with NoSQL Openhack](https://openhack.microsoft.com/), where some of the exercises required attendees (i.e. me!) to implement an [event sourcing pattern](https://docs.microsoft.com/en-us/azure/architecture/patterns/event-sourcing) in Azure. For so long before this point, I had been including them as a component in my architectures and systems design - how hard could they be?

### Getting Started
The main hurdle for me with getting started was understanding the concepts that make up the function, and the boilerplate folder structure that comes out of the box when you initialize your project. Thankfully, one of the things it feels like there has been a great focus on with Azure Functions is the developer experience. Once I had my first couple of functions up and running, I began to find them incredibly intuitive. Conceptually, there are only 2 things you need to understand - triggers and bindings:

*Triggers* define what needs to happen in order to make your functions run. These could be events, requests, or a schedule. Each function has one trigger.

*Bindings* are connections - I think of them as the services I want to "glue" my function to. You can have input and output bindings, and these can be the same or different types of services. 

I find it helpful to focus on the *data movement required to solve my problem* - where does the data come from? Where does it need to go? What is the resulting action or output? From there, Inputs can be mapped into triggers (e.g. HTTP inputs) or bindings (e.g. fetch data from storage/a database), and similar for outputs (e.g. write the output to a datastore, return values over HTTP). Practical examples always help; let's take a look at building a function from scratch to understand these in more detail.

#### Prerequisites 
Before you get started, you'll need to make sure you've got a few tools installed. Firstly, you'll need a text editor - I recommend [Visual Studio Code](https://code.visualstudio.com/) as I find it quick to work with and it's got a great ecosystem of extensions. You'll want to install a couple of these, namely [Azure Functions](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions) and one for the programming language you are working with, in our case, [Python](https://marketplace.visualstudio.com/items?itemName=ms-python.python). You'll of course need Python installed (3.8, 3.7, and 3.6 are supported by Azure Functions). The final thing you'll need is [Azure Functions Core Tools](https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local?tabs=linux%2Ccsharp%2Cbash#install-the-azure-functions-core-tools), which includes a version of the same runtime that powers Azure Functions, which enables you to run Functions in your development environment. 

With the above installed, you're all set!

#### Creating your first function
Start by creating a new directory, then open this in VS Code. When you're in your empty directory, open the command palette (`ctrl` + `shift` + `p`), then find and select _Azure Functions: Create Function_. You'll then have to answer a series of prompts about the new function. 

- Select a *language for your function project*: Choose Python.
- Select a *Python alias to create a virtual environment*: Choose the location of your Python interpreter. If the location isn't shown, type in the full path to your Python binary.
- Select a *template for your project's first function*: Choose HTTP trigger.
- Provide a *function name*: Leave this as HTTPTrigger1.
- *Authorization level*: Choose Anonymous, which enables anyone to call your function endpoint. You can find more information about [access keys for functions here](https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook-trigger?tabs=python#authorization-keys).

You'll now see a bunch of files created in your once empty directory. To run the function locally, start debug mode in VS Code (Run > Start Debugging, or press F5), or type `func start` in your terminal. This will start the local emulator for Azure Functions and enable you to test your code. See the output of the function by heading to the given url in your browser:
```
http://localhost:7071/api/HttpExample?name=World
```

There's a more comprehensive set of instructions (with screenshots too) [available in the documentation](https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-function-vs-code?pivots=programming-language-python) - later steps here also walk through deployment of functions into Azure, which I won't cover here. 

#### The three files you need to know about
Demystifying the files that are automatically generated by the extension will help you get to outcomes faster. As you've found, many files are generated - but the three you should focus on to start with are:
- `local.settings.json` - this is used by Azure Functions Core Tools to connect to _other services in Azure_ when you're running your functions project locally.
- `function.json` defines the triggers and bindings for your functions. These are very thoroughly documented in the [triggers and bindings reference](https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-blob), and you can often re-use code from here with minimal changes. Notice that `$return` is [referenced in the output](https://github.com/joe-plumb/functions-demo/blob/main/HttpTrigger1/function.json#L17) - this is the return value of the `main` function. Using this, you can pass the output of your function to the output binding.
- `__init__.py` is where your code lives. If you've added additional bindings on top of the starter code make sure to , [reference them in the `main` function](https://github.com/joe-plumb/functions-demo/blob/main/HttpTrigger2/__init__.py#L6), and you're away! 

### Taking it further
If you've got this far, you should be good to go! I've included some links and a summary of some other projects and repositories that might help you get started with your use case below. 

- *Event sourcing with Cosmos DB and the Change Feed* - As part of the Openhack that got me started, I pushed some starter functions for working with Cosmos DB to [this repo](https://github.com/joe-plumb/jp-azf-samples). Check this out if you're looking for some examples of getting data from [Event Hubs to Cosmos DB](https://github.com/joe-plumb/jp-azf-samples/tree/main/EventHubToCosmosDB), or working with the [Change](https://github.com/joe-plumb/jp-azf-samples/tree/main/CosmosChangeFeedTrigger) [Feed](https://github.com/joe-plumb/jp-azf-samples/tree/main/CosmosDocumentUpdateOnTrigger). 

- *Creating Serverless APIs to share data from Azure Blob* - After sharing this getting started content with my team, a colleague of mine asked whether Azure Functions would be a good fit to build a REST API for data sharing. Using a HTTP trigger and Azure Blob storage input binding, I was able to knock together [this example](https://github.com/joe-plumb/serverless-data-api). 

-  *End to end tutorial* - This post covers the basics should cover all you need to know to get started. If you want to go into more detail, there is a brilliant end to end [getting started tutorial in the documentation](https://docs.microsoft.com/en-us/azure/developer/python/tutorial-vs-code-serverless-python-01). 

### On my to do list
One pattern I haven't yet had the opportunity to road test is the integration between [Azure Machine Learning and Azure Functions](https://docs.microsoft.com/en-us/azure/machine-learning/how-to-deploy-functions). I can see this being a really powerful pattern for peaky, unpredictable workloads, or for any applications where deploying to Kubernetes would add unnecessary complexity.

### Conclusion
In this post, I've covered how to get started with Azure Functions and Python, including some references to other useful material and some GitHub repositories for examples. Let me know if this was useful, good luck and happy building! 

\- Joe

_Has this helped you get up to speed with serverless? Have you deployed or do you want to know how to deploy ML models to the cloud using functions? [Contact me on Twitter](https://twitter.com/joe_plumb) if so, or if you have any questions or comments!_
